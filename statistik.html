<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Prestasi - PUSDASTRA</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <!-- Video Background -->
    <video autoplay muted loop id="video-bg">
        <source src="assets/hero-video.mp4" type="video/mp4">
    </video>

    <!-- Top Bar -->
    <div class="top-bar d-none d-lg-block">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <span><i class="bi bi-whatsapp text-success me-1"></i> 0851-9615-7474</span>
                <span><i class="bi bi-envelope text-primary me-1"></i> disdikbudpamekasan08@gmail.com</span>
            </div>
            <div>
                <a href="https://www.facebook.com/profile.php?id=100076864329057" target="_blank" title="Facebook"><i
                        class="fab fa-facebook text-glow-shine"></i></a>
                <a href="https://www.instagram.com/dispendikpamekasan?igsh=bWdnbzF3ajA4YWgw_IG" target="_blank"
                    title="Instagram"><i class="fab fa-instagram text-glow-shine"></i></a>
                <a href="https://youtube.com/@disdikbudpamekasan?si=dREjynNqjl29ebF" target="_blank" title="YouTube"><i
                        class="fab fa-youtube text-glow-shine"></i></a>
                <a href="https://www.tiktok.com/@disdikbud.pamekasan?_r=1&_t=ZS-931ZNzQeYdQ_tiktok" target="_blank"
                    title="TikTok"><i class="fab fa-tiktok text-glow-shine"></i></a>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="assets/logo.png" alt="Logo" height="55" class="me-3">
                <div style="line-height: 1.2;">
                    <span class="d-block fw-bold text-success fs-4" style="letter-spacing: 1px;">PUSDASTRA</span>
                    <small class="d-block text-secondary fw-bold" style="font-size: 0.7rem;">
                        PUSAT DATA PRESTASI SISWA<br>DINAS PENDIDIKAN DAN KEBUDAYAAN
                    </small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
                    <li class="nav-item"><a class="nav-link active" href="statistik.html">Statistik</a></li>
                    <li class="nav-item"><a class="nav-link" href="prestasi.html">Daftar Prestasi</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">Tentang</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Kontak</a></li>
                    <li class="nav-item ms-lg-3">
                        <a href="login.html" class="btn btn-primary px-4 rounded-pill">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white py-5 shadow-sm mb-4">
        <div class="container text-center">
            <h1 class="fw-bold text-dark mb-2">Statistik Prestasi</h1>
            <p class="text-muted">Data visualisasi perkembangan prestasi siswa di seluruh wilayah.</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Top Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="display-5 fw-bold text-primary mb-2" id="statTotalPrestasi">0</div>
                        <div class="text-muted">Total Prestasi</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="display-5 fw-bold text-success mb-2" id="statTotalSekolah">0</div>
                        <div class="text-muted">Sekolah Terdaftar</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="display-5 fw-bold text-info mb-2">12</div>
                        <div class="text-muted">Kecamatan</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="display-5 fw-bold text-warning mb-2">2026</div>
                        <div class="text-muted">Tahun Ajaran Aktif</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-bold">Tren Prestasi (Grafik Tahunan)</h5>
                        <small class="text-muted">Menampilkan jumlah prestasi yang diraih setiap tahun</small>
                    </div>
                    <div class="card-body">
                        <canvas id="chartYearly" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-bold">Perbandingan Jenjang</h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div style="width: 100%;">
                            <canvas id="chartJenjang"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-bold">Prestasi per Tingkat Lomba</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTingkat"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-bold">Top 5 Sekolah Berprestasi</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="topSchoolsList">
                            <li class="list-group-item text-center text-muted">Belum ada data sekolah.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 pb-4">
        <div class="container">
            <div class="py-3 text-center">
                <span class="bg-white text-dark px-4 py-2 rounded-pill shadow-sm fw-bold border"
                    style="font-size: 0.85rem;">
                    &copy; Created by Eva_Nuyung_Yunita KP-UIM 2026
                </span>
                </span>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/particles.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { DataStore } from './assets/js/data.js';

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Fetch Data
                const prestasiList = await DataStore.getPrestasi();
                const sekolahList = await DataStore.getSekolah(); // If needed for total count

                // Update Top Cards
                animateValue("statTotalPrestasi", 0, prestasiList.length, 2000);
                animateValue("statTotalSekolah", 0, sekolahList.length, 2000);

                // Process Data for Charts
                const stats = processStats(prestasiList);

                // Render Charts
                renderCharts(stats);
                renderTopSchools(stats.topSchools);

            } catch (error) {
                console.error("Error loading stats:", error);
            }
        });

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            if (!obj) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));

            const timer = setInterval(function () {
                current += increment;
                obj.innerText = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function processStats(data) {
            const years = {};
            const jenjang = { 'SD': 0, 'SMP': 0, 'PAUD': 0 };
            const tingkat = { 'Kecamatan': 0, 'Kabupaten': 0, 'Provinsi': 0, 'Nasional': 0, 'Internasional': 0 };
            const schools = {};

            data.forEach(p => {
                // Year
                const y = p.tanggal ? p.tanggal.substring(0, 4) : 'Unknown';
                if (y !== 'Unknown') years[y] = (years[y] || 0) + 1;

                // Jenjang (Infer from School Name)
                const sName = (p.sekolah || p.school || '').toUpperCase();
                if (sName.includes('SD') || sName.includes('MI')) jenjang['SD']++;
                else if (sName.includes('SMP') || sName.includes('MTS')) jenjang['SMP']++;
                else if (sName.includes('PAUD') || sName.includes('TK') || sName.includes('KB') || sName.includes('RA')) jenjang['PAUD']++;

                // Tingkat
                const t = p.tingkat || 'Unknown';
                if (tingkat[t] !== undefined) tingkat[t]++;

                // Top Schools
                const cleanSchool = p.sekolah || p.school || 'Unknown';
                schools[cleanSchool] = (schools[cleanSchool] || 0) + 1;
            });

            // Sort Top Schools
            const sortedSchools = Object.entries(schools)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            return { years, jenjang, tingkat, topSchools: sortedSchools };
        }

        function renderCharts(stats) {
            // Yearly Trend
            const yearLabels = Object.keys(stats.years).sort();
            const yearData = yearLabels.map(y => stats.years[y]);

            if (document.getElementById('chartYearly')) {
                new Chart(document.getElementById('chartYearly'), {
                    type: 'line',
                    data: {
                        labels: yearLabels,
                        datasets: [{
                            label: 'Jumlah Prestasi',
                            data: yearData,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }

            // Jenjang Pie
            if (document.getElementById('chartJenjang')) {
                new Chart(document.getElementById('chartJenjang'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SD', 'SMP', 'PAUD'],
                        datasets: [{
                            data: [stats.jenjang['SD'], stats.jenjang['SMP'], stats.jenjang['PAUD']],
                            backgroundColor: ['#0d6efd', '#198754', '#ffc107'],
                        }]
                    },
                    options: { responsive: true }
                });
            }

            // Tingkat Bar
            if (document.getElementById('chartTingkat')) {
                new Chart(document.getElementById('chartTingkat'), {
                    type: 'bar',
                    data: {
                        labels: ['Kecamatan', 'Kabupaten', 'Provinsi', 'Nasional', 'Internasional'],
                        datasets: [{
                            label: 'Jumlah',
                            data: [
                                stats.tingkat['Kecamatan'],
                                stats.tingkat['Kabupaten'],
                                stats.tingkat['Provinsi'],
                                stats.tingkat['Nasional'],
                                stats.tingkat['Internasional']
                            ],
                            backgroundColor: ['#0dcaf0', '#0d6efd', '#198754', '#ffc107', '#dc3545'],
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }
        }

        function renderTopSchools(topList) {
            const container = document.getElementById('topSchoolsList');
            if (!container) return;

            if (topList.length === 0) {
                container.innerHTML = '<li class="list-group-item text-center text-muted">Belum ada data sekolah.</li>';
                return;
            }

            container.innerHTML = '';
            topList.forEach((item, index) => {
                const [name, count] = item;
                const badgeColor = index === 0 ? 'warning' : (index === 1 ? 'secondary' : 'light');
                const html = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                             <i class="bi bi-trophy-fill text-${index < 3 ? 'warning' : 'muted'} me-2"></i>
                             ${name}
                        </div>
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `;
                container.innerHTML += html;
            });
        }
    </script>
</body>

</html>