<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Prestasi - PUSDASTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <!-- Video Background -->
    <video autoplay muted loop id="video-bg">
        <source src="assets/hero-video.mp4" type="video/mp4">
    </video>

    <!-- Top Bar -->
    <div class="top-bar d-none d-lg-block">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <span><i class="bi bi-whatsapp text-success me-1"></i> 0851-9615-7474</span>
                <span><i class="bi bi-envelope text-primary me-1"></i> disdikbudpamekasan08@gmail.com</span>
            </div>
            <div>
                <a href="https://www.facebook.com/profile.php?id=100076864329057" target="_blank" title="Facebook"><i
                        class="fab fa-facebook text-glow-shine"></i></a>
                <a href="https://www.instagram.com/dispendikpamekasan?igsh=bWdnbzF3ajA4YWgw_IG" target="_blank"
                    title="Instagram"><i class="fab fa-instagram text-glow-shine"></i></a>
                <a href="https://youtube.com/@disdikbudpamekasan?si=dREjynNqjl29ebF" target="_blank" title="YouTube"><i
                        class="fab fa-youtube text-glow-shine"></i></a>
                <a href="https://www.tiktok.com/@disdikbud.pamekasan?_r=1&_t=ZS-931ZNzQeYdQ_tiktok" target="_blank"
                    title="TikTok"><i class="fab fa-tiktok text-glow-shine"></i></a>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="assets/logo.png" alt="Logo" height="55" class="me-3">
                <div style="line-height: 1.2;">
                    <span class="d-block fw-bold text-success fs-4" style="letter-spacing: 1px;">PUSDASTRA</span>
                    <small class="d-block text-secondary fw-bold" style="font-size: 0.7rem;">
                        PUSAT DATA PRESTASI SISWA<br>DINAS PENDIDIKAN DAN KEBUDAYAAN
                    </small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
                    <li class="nav-item"><a class="nav-link" href="statistik.html">Statistik</a></li>
                    <li class="nav-item"><a class="nav-link active" href="prestasi.html">Daftar Prestasi</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">Tentang</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Kontak</a></li>
                    <li class="nav-item ms-lg-3">
                        <a href="login.html" class="btn btn-primary px-4 rounded-pill">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="bg-white py-5 shadow-sm mb-4">
        <div class="container text-center">
            <h1 class="fw-bold text-dark mb-2">Daftar Prestasi Siswa</h1>
            <p class="text-muted">Cari dan temukan jejak prestasi membanggakan.</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row">
            <!-- Filters Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 fw-bold"><i class="bi bi-funnel"></i> Filter</h5>
                    </div>
                    <div class="card-body">
                        <form id="filterForm">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Pencarian</label>
                                <input type="text" id="filterSearch" class="form-control"
                                    placeholder="Nama siswa/sekolah...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Tahun</label>
                                <select id="filterYear" class="form-select">
                                    <option value="">Semua Tahun</option>
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Jenjang</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="PAUD" id="jenjangPAUD">
                                    <label class="form-check-label" for="jenjangPAUD">PAUD</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="SD" id="jenjangSD">
                                    <label class="form-check-label" for="jenjangSD">SD</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="SMP" id="jenjangSMP">
                                    <label class="form-check-label" for="jenjangSMP">SMP</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Tingkat Lomba</label>
                                <select id="filterTingkat" class="form-select">
                                    <option value="">Semua Tingkat</option>
                                    <option value="Kecamatan">Kecamatan</option>
                                    <option value="Kabupaten">Kabupaten</option>
                                    <option value="Provinsi">Provinsi</option>
                                    <option value="Nasional">Nasional</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Terapkan Filter</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4 py-3">Nama Siswa</th>
                                        <th class="py-3">Asal Sekolah</th>
                                        <th class="py-3">Kejuaraan</th>
                                        <th class="py-3">Tingkat</th>
                                        <th class="py-3">Tahun</th>
                                        <th class="py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="prestasiTableBody">
                                    <!-- Dynamic Data loads here -->
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-muted">Belum ada data prestasi.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation" class="mt-4" id="paginationNav">
                </nav>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 pb-4">
        <div class="container">
            <div class="py-3 text-center">
                <span class="bg-white text-dark px-4 py-2 rounded-pill shadow-sm fw-bold border"
                    style="font-size: 0.85rem;">
                    &copy; Created by Eva_Nuyung_Yunita KP-UIM 2026
                </span>
            </div>
        </div>
    </footer>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Detail Prestasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <!-- Dynamic Content -->
                    <p class="text-center text-muted">Memuat data...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/particles.js"></script>
    <script type="module">
        import { DataStore } from './assets/js/data.js';

        let allData = [];

        document.addEventListener("DOMContentLoaded", () => {
            loadPrestasiTable();

            // Filter Logic
            document.getElementById('filterForm').addEventListener('submit', (e) => {
                e.preventDefault();
                applyFilters();
            });
        });

        async function loadPrestasiTable() {
            const tbody = document.getElementById('prestasiTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Memuat data...</td></tr>';

            try {
                // Fetch from Firebase
                allData = await DataStore.getPrestasi();
                applyFilters(); // Initial render
            } catch (error) {
                console.error("Error loading prestasi:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Gagal memuat data.</td></tr>';
            }
        }

        function applyFilters() {
            let list = [...allData];
            const tbody = document.getElementById('prestasiTableBody');

            // Get Filter Values
            const searchObj = document.getElementById('filterSearch');
            const search = searchObj ? searchObj.value.toLowerCase() : '';

            const yearObj = document.getElementById('filterYear');
            const yearFilter = yearObj ? yearObj.value : '';

            const tingkatObj = document.getElementById('filterTingkat');
            const tingkatFilter = tingkatObj ? tingkatObj.value : '';

            const jenjangPAUD = document.getElementById('jenjangPAUD').checked;
            const jenjangSD = document.getElementById('jenjangSD').checked;
            const jenjangSMP = document.getElementById('jenjangSMP').checked;

            // Apply Filters
            if (search || yearFilter || tingkatFilter || jenjangPAUD || jenjangSD || jenjangSMP) {
                list = list.filter(p => {
                    // Normalize fields
                    const pName = (p.nama || p.siswa || '').toLowerCase();
                    const pSchool = (p.sekolah || p.school || '').toLowerCase();
                    const pLomba = (p.lomba || '').toLowerCase();
                    const pDate = p.tanggal || '';
                    const pTingkat = p.tingkat || '';

                    // 1. Search
                    const matchSearch = !search ||
                        pName.includes(search) ||
                        pSchool.includes(search) ||
                        pLomba.includes(search);

                    // 2. Year
                    const pYear = pDate.substring(0, 4);
                    const matchYear = !yearFilter || pYear === yearFilter;

                    // 3. Tingkat
                    const matchTingkat = !tingkatFilter || pTingkat === tingkatFilter;

                    // 4. Jenjang
                    let matchJenjang = true;
                    if (jenjangPAUD || jenjangSD || jenjangSMP) {
                        const schoolUpper = pSchool.toUpperCase();
                        let isPAUD = jenjangPAUD && (schoolUpper.includes('PAUD') || schoolUpper.includes('TK') || schoolUpper.includes('KB') || schoolUpper.includes('RA'));
                        let isSD = jenjangSD && (schoolUpper.includes('SD') || schoolUpper.includes('MI'));
                        let isSMP = jenjangSMP && (schoolUpper.includes('SMP') || schoolUpper.includes('MTS'));

                        matchJenjang = isPAUD || isSD || isSMP;
                    }

                    return matchSearch && matchYear && matchTingkat && matchJenjang;
                });
            }

            // Render
            if (list.length > 0) {
                tbody.innerHTML = '';
                list.forEach((p, index) => {
                    const year = p.tanggal ? p.tanggal.substring(0, 4) : '-';
                    const siswaName = p.nama || p.siswa || '-';
                    const sekolahName = p.sekolah || p.school || '-';

                    // We use ID instead of index for detail if possible, but for simple view passing index of filtered list is risky if we go back to main list.
                    // Better to pass the object explicitly or ID.
                    // Let's use ID or just keep simple index of filtered list for now (view only).
                    // Actually, let's attach data to the button to avoid scope issues.

                    // But wait, 'showDetail' needs to be globally accessible if called via onclick string.
                    // Since module scope is not global, we attach to window.

                    const row = `
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold">${siswaName}</div>
                            </td>
                            <td>
                                <div class="text-muted">${sekolahName}</div>
                            </td>
                            <td>
                                <div>${p.lomba || '-'}</div>
                                <small class="text-warning"><i class="bi bi-trophy-fill"></i> ${p.peringkat || '-'}</small>
                            </td>
                            <td><span class="badge bg-${getBadgeColor(p.tingkat)}">${p.tingkat || '-'}</span></td>
                            <td>${year}</td>
                            <td><button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="showDetail('${p.id}')">Bukti</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Belum ada data prestasi.</td></tr>`;
            }
        }

        function getBadgeColor(level) {
            if (level === 'Kecamatan') return 'info';
            if (level === 'Kabupaten') return 'primary';
            if (level === 'Provinsi') return 'success';
            if (level === 'Nasional') return 'danger';
            return 'secondary';
        }

        // Expose to window
        window.showDetail = function (id) {
            const p = allData.find(d => d.id === id);
            if (!p) return;

            const modalBody = document.getElementById('modalContent');
            const modalTitle = document.querySelector('#detailModal .modal-title');
            if (modalTitle) modalTitle.innerText = "Bukti Prestasi";

            if (p.bukti) {
                // Check if PDF or Image
                if (p.bukti.startsWith('data:application/pdf') || p.bukti.endsWith('.pdf')) {
                    modalBody.innerHTML = `
                        <iframe src="${p.bukti}" style="width:100%; height:500px;" frameborder="0"></iframe>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div class="d-flex justify-content-center align-items-center">
                            <img src="${p.bukti}" class="img-fluid rounded shadow-sm border" alt="Bukti Prestasi" style="max-height: 80vh; max-width: 100%;">
                        </div>
                    `;
                }
            } else {
                modalBody.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">Belum ada bukti yang diunggah.</p>
                    </div>
                `;
            }
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        };
    </script>
</body>

</html>